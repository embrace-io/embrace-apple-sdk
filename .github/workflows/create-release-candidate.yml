name: Create Release Candidate (6.x)

env:
  ARCHIVE_QUIET_MODE: 1
  AWS_DEFAULT_REGION: "${{ vars.AWS_DEFAULT_REGION }}"

on:
  # Temporal
  push:
    branches:
      - "release/*"

  workflow_dispatch:
    inputs:
      rc_version:
        description: "The release candidate version to create"
        required: true
      override_version:
        description: "Should delete previous podspec (if exist) and create a new one"
        type: boolean
        default: false

permissions:
  id-token: write
  contents: write
  packages: read

jobs:
  rc_version_number:
    name: Set RC_VERSION from Branch if Necessary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      RC_VERSION: ${{ github.event.inputs.rc_version }}
    outputs:
      rc_version: ${{ steps.extractor.outputs.rc_version }}
      on_release_branch: ${{ steps.extractor.outputs.on_release_branch }}
    steps:
      - name: Extract RC Version Number
        id: extractor
        run: |
          if [ -z "$RC_VERSION" ]; then
            BRANCH_VERSION=${GITHUB_REF_NAME##release/}
            RC_VERSION=$BRANCH_VERSION
            echo "on_release_branch=true" >> $GITHUB_OUTPUT
          fi

          if [[ "$RC_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Using RC_VERSION of $RC_VERSION"
          else
            echo "Error: RC_VERSION of '$RC_VERSION' is not the correct format."
            exit 1
          fi

          echo "Using RC_VERSION $RC_VERSION"
          echo "rc_version=$RC_VERSION" >> $GITHUB_OUTPUT

  build_release_candidate:
    name: Bump Version and Build Release
    runs-on: macos-13
    timeout-minutes: 60
    needs:
      - rc_version_number
    env:
      RC_VERSION: ${{ needs.rc_version_number.outputs.rc_version }}
      ON_RELEASE_BRANCH: ${{ needs.rc_version_number.outputs.on_release_branch }}
      DEV_AWS_BUCKET_MANIFEST_URL: "https://downloads.stg.emb-eng.com/embrace-apple-sdk.json"
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Bump Version
        run: |
          echo "Bumping version to '$RC_VERSION'"
          bin/version_bump $RC_VERSION

          # DEV: show diff
          git diff

          if [[ `git status --porcelain` ]]; then
            echo "VERSION_BUMPED=true" >> $GITHUB_ENV
          fi

      - name: Commit Version Changes
        if: env.VERSION_BUMPED == 'true'
        run: |
          git config --global user.name "embrace-ci"
          git config --global user.email "embrace-ci@users.noreply.github.com"

          git add EmbraceIO.podspec \
              EmbraceIO-DEV.podspec \
              Sources/EmbraceCommonInternal/EmbraceMeta.swift
          git diff --cached
          git commit -m "CI/CD: Bumps version to '$RC_VERSION'"
          git push

      - name: Select Xcode 15
        run: sudo xcode-select -switch /Applications/Xcode_15.1.app

      - name: Install Mise
        run: |
          # Install Mise
          curl https://mise.jdx.dev/install.sh | sh
          echo "$HOME/.local/share/mise/bin" >> $GITHUB_PATH
          echo "$HOME/.local/share/mise/shims" >> $GITHUB_PATH

      - name: Build XCFramework
        run: |
          eval "$(~/.local/bin/mise activate bash)" >> ~/.bashrc
          echo "$PATH"
          mise doctor
          ./bin/build_xcframeworks.sh

      # TODO: Finish this step
      - name: Sign XCFramework
        run: echo "We're not going to sign the xcframeworks at this moment. Will do it later"

      - name: Zip XCFrameworks
        run: |
          DIR=$(pwd -P)
          cd build; zip -r "$DIR/xcframeworks.zip" xcframeworks

      - name: Store XCFrameworks
        uses: actions/upload-artifact@v4
        with:
          name: Embrace-Universal Build Artifacts
          path: xcframeworks.zip

  archive_cocoapods_artifacts:
    name: Archive Cocoapods Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - rc_version_number
      - build_release_candidate
    env:
      RC_VERSION: ${{ needs.rc_version_number.outputs.rc_version }}

    steps:
      - name: Determine latest embrace_support.zip version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version=$(gh release list --repo embrace-io/action-symbol-upload --json tagName --jq '.[] | select(.tagName | startswith("embrace_support-")) | .tagName' --order desc | head -1)
          echo "Using tool version ${version}"
          echo "SUPPORT_TOOL=${version}" >> $GITHUB_ENV

      - name: Download embrace_support.zip
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release --repo embrace-io/action-symbol-upload download ${{ env.SUPPORT_TOOL }} --pattern 'embrace_support-*' --clobber

      - name: Verify and extract embrace_support.zip
        run: |
          if /usr/bin/shasum -a 256 -c ${{ env.SUPPORT_TOOL }}.zip.sha256; then
            unzip -o ${{ env.SUPPORT_TOOL }}.zip
          else
            echo "Checksum verification failed, aborting."
            exit 1
          fi

      - name: Download Artifacts - XCFrameworks
        uses: actions/download-artifact@v4
        with:
          name: Embrace-Universal Build Artifacts

      - name: Unzip Embrace-Universal Build Artifacts
        run: unzip xcframeworks.zip

      - name: Create Cocoapods Release Zip
        run: |
          DIR=$(pwd -P)
          mkdir artifacts
          mv run.sh upload artifacts/
          chmod +x artifacts/run.sh artifacts/upload

          cd artifacts; zip "$DIR/embrace_$RC_VERSION.zip" *; cd -;
          zip "$DIR/embrace_$RC_VERSION.zip" -r xcframeworks/*; cd -;

      - name: Store Cocoapods Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Cocoapods Release Archive
          path: embrace_${{ env.RC_VERSION }}.zip

  publish_artifacts:
    name: Publish to S3
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - rc_version_number
      - archive_cocoapods_artifacts

    env:
      RC_VERSION: ${{ needs.rc_version_number.outputs.rc_version }}

    steps:
      - name: Set AWS identifiers
        run: |
          echo AWS_LOGIN_ROLE=arn:aws:iam::$(echo '${{ vars.AWS_ACCOUNT_IDS }}' | jq .login):role/login-embrace-downloads >> $GITHUB_ENV
          echo AWS_ASSUME_ROLE=arn:aws:iam::$(echo '${{ vars.AWS_ACCOUNT_IDS }}' | jq .staging):role/staging-embrace-downloads >> $GITHUB_ENV
          # TODO: this should use matrix.environment once we split embrace--<env>-downloads buckets
          # echo AWS_ASSUME_ROLE=arn:aws:iam::$(echo '${{ vars.AWS_ACCOUNT_IDS }}' | jq .${{ matrix.environment }}):role/${{ matrix.environment }}-embrace-ios-sdk >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_LOGIN_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Assume AWS role
        run: |
          pip install --upgrade awscli
          credentials=$(aws sts assume-role --role-arn "${{ env.AWS_ASSUME_ROLE }}" --role-session-name "`echo $GITHUB_REPOSITORY | tr "/" "-"`" --duration-seconds 900)
          echo "AWS_ACCESS_KEY_ID=`echo $credentials | jq -r .Credentials.AccessKeyId`" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=`echo $credentials | jq -r .Credentials.SecretAccessKey`" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=`echo $credentials | jq -r .Credentials.SessionToken`" >> $GITHUB_ENV

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Embrace-Universal Build Artifacts
          path: embrace

      - name: Download Cocoapods Release Archive
        uses: actions/download-artifact@v4
        with:
          name: Cocoapods Release Archive
          path: cocoapods/

      - name: Upload to AWS
        env:
          AWS_BUCKET_STAGING: "s3://embrace-staging-downloads"
          AWS_BUCKET_DSYM: "s3://embrace-staging-dsyms"
        run: |
          shasum cocoapods/embrace_*.zip
          aws s3 cp --acl=public-read cocoapods/embrace_*.zip ${{ env.AWS_BUCKET_STAGING }}
          rm -rf cocoapods

          # missing dsysm upload

      - name: Flush CloudFront CDN
        env:
          # downloads.stg.emb-eng.com
          AWS_CLOUDFRONT_ID: E1Q329634TJ1Q9
        run: |
          echo "$(date): Invalidating https://us-east-1.console.aws.amazon.com/cloudfront/v3/home?region=us-west-2#/distributions/${{ env.AWS_CLOUDFRONT_ID }}"
          aws cloudfront create-invalidation --region us-west-2 --distribution-id ${{ env.AWS_CLOUDFRONT_ID }} --paths '/*' | tee invalidation.json

          invalidation_id=$(cat invalidation.json | jq -r .Invalidation.Id)

          echo "$(date): Waiting for completion of https://us-east-1.console.aws.amazon.com/cloudfront/v3/home?region=us-west-2#/distributions/${{ env.AWS_CLOUDFRONT_ID }}/invalidations/details/${invalidation_id}"
          aws cloudfront wait invalidation-completed --region us-west-2 --distribution-id ${{ env.AWS_CLOUDFRONT_ID }} --id $invalidation_id

  push_podspec:
    name: Push Podspec to Cocoapods
    runs-on: macos-13
    timeout-minutes: 10
    needs:
      - rc_version_number
      - publish_artifacts
    env:
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      RC_VERSION: ${{ needs.rc_version_number.outputs.rc_version }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: embrace-apple-core-internal

      - name: Be sure Podspec has bumped version
        # If we haven't pushed version bump podspec will use existing version
        # See "Commit Version Changes" step
        run: |
          cd embrace-apple-core-internal
          bin/version_bump $RC_VERSION --cocoapods
      - name: Delete and recreate podspec if override is true
        if: ${{ inputs.override_version }}
        run: |
          info=$(pod trunk info EmbraceIO-DEV)
          if echo "$info" | grep -q "$version"; then
            echo "y" | pod trunk delete EmbraceIO-DEV $RC_VERSION
          else
            echo "Version doesn't exist at all, so it shouldn't be removed"
          fi
      - name: Push EmbraceIO-DEV Podspec
        run: |
          pod trunk push embrace-apple-core-internal/EmbraceIO-DEV.podspec --allow-warnings
      - name: Cleanup old EmbraceIO-DEV Cocoapods versions
        env:
          KEEP_VERSIONS: 5
        run: |
          brew install coreutils # Install sane version of "head"

          for old_version in $(pod trunk info EmbraceIO-DEV | grep '^      -' | grep ' (20' | ghead -n -${KEEP_VERSIONS} | awk '{print $2}'); do
            echo "Removing $old_version"
            echo "y" | pod trunk delete EmbraceIO-DEV $old_version || echo "We can ignore any errors"
          done

# Note: missing/removed steps from old sdk
# - Store embrace-apple-sdk.json
# - workflow_update_docs
# - archive_carthage_artifacts (dont think so)
# - update_spm (should do)
# - create_prs (i don't know if it's needed)
# - workflow_after_release (idem above)
