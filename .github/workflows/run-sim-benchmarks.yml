name: Sim Benchmarks

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  run-tests:
    name: Sim Benchmarks
    runs-on: macos-latest-large
    timeout-minutes: 60
    strategy:
      fail-fast: false

    permissions:
      checks: write
      pull-requests: write
    steps:
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_26.0.app
          xcodebuild -version

      - name: Ensure the Platform is Downloaded
        run: |
          xcodebuild -runFirstLaunch
          xcrun simctl list
          xcodebuild -downloadPlatform iOS
          xcodebuild -runFirstLaunch

      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          pip install scipy pygithub
          
      - name: Checkout PR
        uses: actions/checkout@v4
        timeout-minutes: 2
        with:
          persist-credentials: false

      - name: Copy Performance Stats Script
        run: |
          PERF_STATS_SCRIPT=$(mktemp)
          cp bin/extract_perf_stats "$PERF_STATS_SCRIPT"
          chmod +x "$PERF_STATS_SCRIPT"
          echo "PERF_STATS_SCRIPT=$PERF_STATS_SCRIPT" >> $GITHUB_ENV

      - name: Generate Result Bundle Path
        id: result-path
        run: echo "path=$(mktemp -u).xcresult" >> $GITHUB_OUTPUT

      - name: Run PR Tests
        uses: embrace-io/xcodebuild@5ec9e396576d4142d6c8ff01767765ea649e803e # acohen/test-iterations
        id: run-tests
        with:
          action: test
          workspace: ".swiftpm/xcode/package.xcworkspace"
          scheme: EmbraceIO-Package
          platform: iOS
          arch: arm64
          test-iterations: 5
          result-bundle-path: ${{ steps.result-path.outputs.path }}
          only-testing: EmbraceIOTests/PerformanceTests

      - name: Extract PR Performance Stats
        id: crunch-results-pr
        env:
          RESULT_PATH: ${{ steps.result-path.outputs.path }}
        run: |
          RESULTS=$($PERF_STATS_SCRIPT "$RESULT_PATH")
          echo "$RESULTS"
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout Main
        uses: actions/checkout@v4
        timeout-minutes: 2
        with:
          ref: main
          persist-credentials: false

      - name: Generate Main Result Bundle Path
        id: result-path-main
        run: echo "path=$(mktemp -u).xcresult" >> $GITHUB_OUTPUT

      - name: Run Main Tests
        uses: embrace-io/xcodebuild@5ec9e396576d4142d6c8ff01767765ea649e803e # acohen/test-iterations
        id: run-tests-main
        with:
          action: test
          workspace: ".swiftpm/xcode/package.xcworkspace"
          scheme: EmbraceIO-Package
          platform: iOS
          arch: arm64
          test-iterations: 5
          result-bundle-path: ${{ steps.result-path-main.outputs.path }}
          only-testing: EmbraceIOTests/PerformanceTests

      - name: Extract Main Performance Stats
        id: crunch-results-main
        env:
          RESULT_PATH: ${{ steps.result-path-main.outputs.path }}
        run: |
          RESULTS=$($PERF_STATS_SCRIPT "$RESULT_PATH")
          echo "$RESULTS"
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Comparison
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERF_PR: ${{ steps.crunch-results-pr.outputs.results }}
          PERF_MAIN: ${{ steps.crunch-results-main.outputs.results }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TITLE: "ðŸš€ Simulator Benchmarks (PR vs Main)"
        run: |
          python bin/perfcomp.py

