name: On Device Benchmarks

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  THRESHOLD_PCT: 5.0
  ALPHA: 0.05
  TITLE: "ðŸš€ Device Benchmarks (PR vs Main)"

jobs:
  browserstack-pr:
    name: Run BrowserStack Tests on PR
    uses: ./.github/workflows/browserstack.yml
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  browserstack-main:
    name: Run BrowserStack Tests on Main
    uses: ./.github/workflows/browserstack.yml
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
    with:
      ref: main

  compare-results:
    name: Compare Performance Results
    needs: [browserstack-pr, browserstack-main]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install scipy pygithub

      - name: Run Performance Comparison
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERF_PR: ${{ needs.browserstack-pr.outputs.results }}
          PERF_MAIN: ${{ needs.browserstack-main.outputs.results }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          THRESHOLD_PCT: ${{ env.THRESHOLD_PCT }}
          ALPHA: ${{ env.ALPHA }}
          TITLE: ${{ env.TITLE }}
        run: |
          python bin/perfcomp.py

      - name: Display Results Summary
        if: always()
        env:
          PR_BUILD_ID: ${{ needs.browserstack-pr.outputs.build_id }}
          PR_BUILD_STATUS: ${{ needs.browserstack-pr.outputs.build_status }}
          MAIN_BUILD_ID: ${{ needs.browserstack-main.outputs.build_id }}
          MAIN_BUILD_STATUS: ${{ needs.browserstack-main.outputs.build_status }}
        run: |
          echo "### BrowserStack Test Results"
          echo ""
          echo "**PR Branch:**"
          echo "- Build ID: $PR_BUILD_ID"
          echo "- Status: $PR_BUILD_STATUS"
          echo ""
          echo "**Main Branch:**"
          echo "- Build ID: $MAIN_BUILD_ID"
          echo "- Status: $MAIN_BUILD_STATUS"
