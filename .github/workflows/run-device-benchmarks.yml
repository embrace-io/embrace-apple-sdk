name: On Device Benchmarks

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/run-device-benchmarks.yml'
      - '.github/workflows/browserstack.yml'
      - 'bin/perfcomp.py'
      - 'Package.swift'
      - 'Sources/**'
      - 'Examples/Benchmarks/**'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/run-device-benchmarks.yml'
      - '.github/workflows/browserstack.yml'
      - 'bin/perfcomp.py'
      - 'Package.swift'
      - 'Sources/**'
      - 'Examples/Benchmarks/**'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  THRESHOLD_PCT: 5.0
  ALPHA: 0.05
  TITLE: "ðŸš€ Device Benchmarks (PR vs Main)"

jobs:
  browserstack-pr:
    name: Run BrowserStack Tests on PR
    uses: ./.github/workflows/browserstack.yml
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  browserstack-main:
    name: Run BrowserStack Tests on Main
    needs: [browserstack-pr]
    if: success()
    uses: ./.github/workflows/browserstack.yml
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
    with:
      ref: main

  compare-results:
    name: Compare Performance Results
    needs: [browserstack-pr, browserstack-main]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install scipy pygithub

      - name: Run Performance Comparison
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERF_PR: ${{ needs.browserstack-pr.outputs.results }}
          PERF_MAIN: ${{ needs.browserstack-main.outputs.results }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          THRESHOLD_PCT: ${{ env.THRESHOLD_PCT }}
          ALPHA: ${{ env.ALPHA }}
          TITLE: ${{ env.TITLE }}
        run: |
          python bin/perfcomp.py