name: Run Swift Tests

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: true
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  run-tests:
    name: Test ${{ matrix.platform }}, on macOS ${{ matrix.macos-version }}, with Xcode ${{ matrix.xcode_version }}
    timeout-minutes: 30
    runs-on: macos-${{ matrix.macos-version }}
    strategy:
      fail-fast: false
      matrix:
        platform: ["iOS"]
        xcode_version: ["16.2"]
        macos-version: ["14"]
        include:

          # iOS
          - platform: "iOS"
            xcode_version: "16.2"
            macos-version: "14"

          - platform: "iOS"
            xcode_version: "16.4"
            macos-version: "15"

          - platform: "iOS"
            xcode_version: "26.0"
            macos-version: "15"

          # tvOS
          - platform: "tvOS"
            xcode_version: "16.4"
            macos-version: "15"

          # macOS
          - platform: "macOS"
            xcode_version: "16.4"
            macos-version: "15"

          # watchOS
          - platform: "watchOS"
            xcode_version: "16.4"
            macos-version: "15"

    permissions:
      checks: write
    steps:
        # See https://github.com/actions/runner-images/blob/main/images/macos/macos-15-Readme.md
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode_version }}.app
          xcodebuild -version
        continue-on-error: false

      - uses: actions/checkout@v4
        timeout-minutes: 2
        with:
          persist-credentials: false

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build/checkouts
            .build/artifacts
            .build/*-apple-*/debug/Swift*
            .build/*-apple-*/debug/SourceKit*
            .build/*-apple-*/debug/ArgumentParser*
          key: ${{ runner.os }}-spm-build-cache-test-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-build-cache-test

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Run Tests
        run: bin/test ${{ matrix.platform }} | xcbeautify && exit ${PIPESTATUS[0]}
        timeout-minutes: 30

      - name: Upload xcresult Bundle on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: output_xcresult_${{ matrix.platform }}_xcode_${{ matrix.xcode_version }}_macos_${{ matrix.macos-version }}
          path: .build/test/output.xcresult
      
      - name: List result files
        run: ls -R .build/test | grep xcresult

      - name: Convert results for Codecov
        run: |
          brew install a7ex/homebrew-formulae/xcresultparser
          xcresultparser --output-format cobertura .build/test/output.xcresult > .build/test/output.xcresult.xml

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          plugins: xcode
          files: .build/test/output.xcresult.xml
          fail_ci_if_error: true
