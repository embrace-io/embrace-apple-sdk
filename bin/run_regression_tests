#!/bin/bash
set -Eeuo pipefail

$EMB_BIN_HOME/platform
source $EMB_BIN_HOME/destinations

echo "EmbraceIO"
get_sim ".swiftpm/xcode/package.xcworkspace" "EmbraceIO-Package" "iPhone~Pro" "iOS Simulator" "~" 1

if [ -d "Examples/Benchmarks/Benchmarks.xcworkspace" ]; then
    echo "Benchmarks"
    get_sim "Examples/Benchmarks/Benchmarks.xcworkspace" "Benchmarks" "iPhone~Pro" "iOS Simulator" "~" 1
fi

$EMB_BIN_HOME/benchmarks >benchmarks.json
$EMB_BIN_HOME/perf >perf.json

jq -n \
    --slurpfile a perf.json \
    --slurpfile b benchmarks.json \
    '$a[0] + $b[0]' \
    > combined.json

cat combined.json

echo "out<<EOF" >> "$GITHUB_OUTPUT"
cat combined.json >> "$GITHUB_OUTPUT"
echo "EOF" >> "$GITHUB_OUTPUT"